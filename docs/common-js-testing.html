<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Module Testing · Jest</title><meta name="viewport" content="width=device-width"><meta property="og:title" content="Module Testing · Jest"><meta property="og:type" content="website"><meta property="og:url" content="https://facebook.github.io/jest/index.html"><meta property="og:image" content="https://facebook.github.io/jest/img/opengraph.png"><meta property="og:description" content="Dependency Injection is a way to mock dependencies in order to make code"><link rel="shortcut icon" href="/jest/img/favicon.png"><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"><link rel="stylesheet" href="/jest/css/jest.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.020/css/hack.min.css"><script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script></head><body class="sideNavVisible"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/jest/"><img src="/jest/img/jest-outline.svg"><h2>Jest</h2></a><div class="navigationWrapper navigationSlider"><div class="navSlideout"><i class="menuExpand"><span></span><span></span><span></span></i></div><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li><a href="/jest/docs/tutorial.html#content" class="active">Docs</a></li><li><a href="/jest/support.html#content" class="">Support</a></li><li><a href="/jest/blog/#content" class="">Blog</a></li><li><a href="https://github.com/facebook/jest" class="">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input id="search_input_react" type="text" placeholder="Search"></li></ul></nav><script>
          var triggers = document.getElementsByClassName('menuExpand');
          var navs = document.getElementsByClassName('navSlideout');
          for (var i=0; i < triggers.length; i++) {
            triggers[i].onclick = function() {
              for (var j=0; j < navs.length; j++) {
                navs[j].classList.toggle('navSlideoutActive');
                navs[j].nextSibling.classList.toggle('slidingNavActive');
              }
            };
          }
        </script></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><a href="/jest/docs/">Docs</a><i>›</i><span>Core Concepts</span></h2></div><div class="navGroups"><div class="navGroup navGroupActive"><h3>Quick Start</h3><ul><li class="navListItem"><a class="navItem" href="/jest/docs/getting-started.html#content">Getting Started</a></li><li class="navListItem"><a class="navItem" href="/jest/docs/tutorial.html#content">Tutorial</a></li><li class="navListItem"><a class="navItem" href="/jest/docs/tutorial-react.html#content">Tutorial – React</a></li><li class="navListItem"><a class="navItem" href="/jest/docs/tutorial-react-native.html#content">Tutorial – React Native</a></li><li class="navListItem"><a class="navItem" href="/jest/docs/tutorial-async.html#content">Tutorial – Async</a></li><li class="navListItem"><a class="navItem" href="/jest/docs/tutorial-webpack.html#content">Tutorial – webpack</a></li><li class="navListItem"><a class="navItem" href="/jest/docs/tutorial-jquery.html#content">Tutorial – jQuery</a></li></ul></div><div class="navGroup navGroupActive"><h3>Core Concepts</h3><ul><li class="navListItem navListItemActive"><a class="navItem navItemActive" href="/jest/docs/common-js-testing.html#content">Module Testing</a></li><li class="navListItem"><a class="navItem" href="/jest/docs/automatic-mocking.html#content">Automatic Mocking</a></li></ul></div><div class="navGroup navGroupActive"><h3>Reference</h3><ul><li class="navListItem"><a class="navItem" href="/jest/docs/api.html#content">API Reference</a></li><li class="navListItem"><a class="navItem" href="/jest/docs/troubleshooting.html#content">Troubleshooting</a></li><li class="navListItem"><a class="navItem" href="/jest/docs/mock-functions.html#content">Mock functions</a></li><li class="navListItem"><a class="navItem" href="/jest/docs/manual-mocks.html#content">Manual mocks</a></li><li class="navListItem"><a class="navItem" href="/jest/docs/timer-mocks.html#content">Timer mocks</a></li></ul></div></div></section></div><script>
          var toggler = document.getElementById('navToggler');
          var nav = document.getElementById('docsNav');
          toggler.onclick = function() {
            nav.classList.toggle('docsSliderActive');
          };
        </script></nav></div><div class="container mainContainer documentContainer postContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link" href="https://github.com/facebook/jest/edit/master/docs/CommonJSTesting.md" target="_blank">Edit on GitHub</a><h1>Module Testing</h1></header><article><div><p>Dependency Injection is a way to mock dependencies in order to make code
testable. In this article, we&#x27;re going to see how Jest achieves the same result
using a different approach.</p><h2><a class="anchor" name="what-is-the-problem"></a>What is the problem? <a class="hash-link" href="#what-is-the-problem">#</a></h2><pre class="prism language-javascript">
<span class="token keyword">function</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&#x27;POST&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;http://facebook.github.io/jest/&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre><p>This function has a dependency on the <code>XHR</code> class and uses the global namespace
in order to get a reference to <code>XHR</code>. In order to mock this dependency, we have
to monkey patch the global object.</p><pre class="prism language-javascript">
<span class="token keyword">let</span> oldXHR <span class="token operator">=</span> XHR<span class="token punctuation">;</span>
XHR <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">MockXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span spellcheck="true" class="token comment">// assert that MockXHR got called with the right arguments</span>
XHR <span class="token operator">=</span> oldXHR<span class="token punctuation">;</span> <span spellcheck="true" class="token comment">// if you forget this bad things will happen</span></pre><p>This small example shows two important concepts. We need a way to get a
reference to <code>XHR</code> and a way to provide two implementations: one for the normal
execution and one for testing.</p><p>In this case, the solution swaps implementations on the global object. It
works, but it&#x27;s not ideal for reasons outlined in this article:
<a href="http://misko.hevery.com/code-reviewers-guide/flaw-brittle-global-state-singletons/" target="_blank">Brittle Global State &amp; Singletons</a>.</p><h2><a class="anchor" name="how-does-angular-solve-this-problem"></a>How does Angular solve this problem? <a class="hash-link" href="#how-does-angular-solve-this-problem">#</a></h2><p>In Angular, you write your code by passing dependencies as arguments:</p><pre class="prism language-javascript">
<span class="token keyword">function</span> <span class="token function">doWork</span><span class="token punctuation">(</span>XHR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&#x27;POST&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;http://facebook.github.io/jest/&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre><p>It makes it very easy to write a test – you pass your mocked version as
argument to your function:</p><pre class="prism language-javascript">
<span class="token keyword">const</span> MockXHR <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">doWork</span><span class="token punctuation">(</span>MockXHR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span spellcheck="true" class="token comment">// assert that MockXHR got called with the right arguments</span></pre><p>But it&#x27;s a pain to thread these constructor arguments throughout a real
application. So Angular uses an <code>injector</code> behind the scenes. This makes it
easy to create instances that automatically acquire their dependencies:</p><pre class="prism language-javascript">
<span class="token keyword">const</span> injectedDoWork <span class="token operator">=</span> injector<span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>doWork<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span spellcheck="true" class="token comment">// is the equivalent of writing</span>

<span class="token keyword">function</span> <span class="token function">injectedDoWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> xhr <span class="token operator">=</span> injector<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;XHR&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&#x27;POST&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;http://facebook.github.io/jest/&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre><p>Angular inspects the function and sees that it has one argument called <code>XHR</code>.
It then provides the value <code>injector.get(&#x27;XHR&#x27;)</code> for the variable <code>XHR</code>.</p><p>In order to have a testable function in Angular, you must conform to this
specific pattern and pass it into Angular&#x27;s DI framework before you can use it.</p><h2><a class="anchor" name="how-does-jest-solve-this-problem"></a>How does Jest solve this problem? <a class="hash-link" href="#how-does-jest-solve-this-problem">#</a></h2><p>Angular uses function arguments as a way to model dependencies and has to
implement its own module loader. Most large JavaScript applications already use
a module loader with the <code>require</code> function. In a CommonJS JavaScript app, the
example above would look more like this:</p><pre class="prism language-javascript">
<span class="token keyword">const</span> XHR <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;XHR&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&#x27;POST&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;http://facebook.github.io/jest/&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre><p>The interesting aspect of this code is that the dependency on <code>XHR</code> is
marshalled by <code>require()</code>. The idea behind Jest is to use this as a seam for
inserting test doubles by implementing a special <code>require</code> in the testing
environment.</p><pre class="prism language-javascript">
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&#x27;XHR&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;XHR&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span spellcheck="true" class="token comment">// returns a mocked version of XHR</span>

jest<span class="token punctuation">.</span><span class="token function">unmock</span><span class="token punctuation">(</span><span class="token string">&#x27;XHR&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;XHR&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span spellcheck="true" class="token comment">// returns the real XHR module</span></pre><p>This allows you to write your tests like this:</p><pre class="prism language-javascript">
jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&#x27;XHR&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span spellcheck="true" class="token comment">// note: by default, this is done automatically in Jest</span>
<span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> MockXHR <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;XHR&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span spellcheck="true" class="token comment">// assert that MockXHR got called with the right arguments</span></pre><h2><a class="anchor" name="conclusion"></a>Conclusion <a class="hash-link" href="#conclusion">#</a></h2><p>Dependency Injection is a very powerful tool that lets you swap the
implementation of any module at any time. However, the vast majority of code
only deals with one implementation for production and one for testing. Jest is
designed to make this common case much simpler to test.</p><p>Jest allows for mocking dependencies in the same way that Angular does, but
instead of building a proprietary module loader, it uses CommonJS. This enables
you to test any existing code that already uses CommonJS without having to
heavily refactor it to make it compatible with a another module system such as
Angular&#x27;s.</p><p>Fortunately, because Angular code has been designed for testing in any
environment, it is still possible to test Angular code using Jest.</p></div></article></div><div class="docs-prevnext"><a class="docs-next" href="automatic-mocking.html#content">Next →</a></div></div></div></div><div class="footerContainer"><div class="wrapper footerWrapper"><div class="footerBlocks"><div class="footerSection fbOpenSourceFooter"><svg class="facebookOSSLogoSvg" viewBox="0 0 1133.9 1133.9" x="0px" y="0px"><g><path class="logoRing outerRing" d="M 498.3 3.7 c 153.6 88.9 307.3 177.7 461.1 266.2 c 7.6 4.4 10.3 9.1 10.3 17.8 c -0.3 179.1 -0.2 358.3 0 537.4 c 0 8.1 -2.4 12.8 -9.7 17.1 c -154.5 88.9 -308.8 178.1 -462.9 267.5 c -9 5.2 -15.5 5.3 -24.6 0.1 c -153.9 -89.2 -307.9 -178 -462.1 -266.8 C 3 838.8 0 833.9 0 825.1 c 0.3 -179.1 0.2 -358.3 0 -537.4 c 0 -8.6 2.6 -13.6 10.2 -18 C 164.4 180.9 318.4 92 472.4 3 C 477 -1.5 494.3 -0.7 498.3 3.7 Z M 48.8 555.3 c 0 79.9 0.2 159.9 -0.2 239.8 c -0.1 10 3 15.6 11.7 20.6 c 137.2 78.8 274.2 157.8 411 237.3 c 9.9 5.7 17 5.7 26.8 0.1 c 137.5 -79.8 275.2 -159.2 412.9 -238.5 c 7.4 -4.3 10.5 -8.9 10.5 -17.8 c -0.3 -160.2 -0.3 -320.5 0 -480.7 c 0 -8.8 -2.8 -13.6 -10.3 -18 C 772.1 218 633.1 137.8 494.2 57.4 c -6.5 -3.8 -11.5 -4.5 -18.5 -0.5 C 336.8 137.4 197.9 217.7 58.8 297.7 c -7.7 4.4 -10.2 9.2 -10.2 17.9 C 48.9 395.5 48.8 475.4 48.8 555.3 Z"></path><path class="logoRing middleRing" d="M 184.4 555.9 c 0 -33.3 -1 -66.7 0.3 -100 c 1.9 -48 24.1 -86 64.7 -110.9 c 54.8 -33.6 110.7 -65.5 167 -96.6 c 45.7 -25.2 92.9 -24.7 138.6 1 c 54.4 30.6 108.7 61.5 162.2 93.7 c 44 26.5 67.3 66.8 68 118.4 c 0.9 63.2 0.9 126.5 0 189.7 c -0.7 50.6 -23.4 90.7 -66.6 116.9 c -55 33.4 -110.8 65.4 -167.1 96.5 c -43.4 24 -89 24.2 -132.3 0.5 c -57.5 -31.3 -114.2 -64 -170 -98.3 c -41 -25.1 -62.9 -63.7 -64.5 -112.2 C 183.5 621.9 184.3 588.9 184.4 555.9 Z M 232.9 556.3 c 0 29.5 0.5 59.1 -0.1 88.6 c -0.8 39.2 16.9 67.1 50.2 86.2 c 51.2 29.4 102.2 59.2 153.4 88.4 c 31.4 17.9 63.6 18.3 95 0.6 c 53.7 -30.3 107.1 -61.2 160.3 -92.5 c 29.7 -17.5 45 -44.5 45.3 -78.8 c 0.6 -61.7 0.5 -123.5 0 -185.2 c -0.3 -34.4 -15.3 -61.5 -44.9 -79 C 637.7 352.6 583 320.8 527.9 290 c -27.5 -15.4 -57.2 -16.1 -84.7 -0.7 c -56.9 31.6 -113.4 64 -169.1 97.6 c -26.4 15.9 -40.7 41.3 -41.1 72.9 C 232.6 491.9 232.9 524.1 232.9 556.3 Z"></path><path class="logoRing innerRing" d="M 484.9 424.4 c 69.8 -2.8 133.2 57.8 132.6 132 C 617 630 558.5 688.7 484.9 689.1 c -75.1 0.4 -132.6 -63.6 -132.7 -132.7 C 352.1 485 413.4 421.5 484.9 424.4 Z M 401.3 556.7 c -3.4 37.2 30.5 83.6 83 84.1 c 46.6 0.4 84.8 -37.6 84.9 -84 c 0.1 -46.6 -37.2 -84.4 -84.2 -84.6 C 432.2 472.1 397.9 518.3 401.3 556.7 Z"></path></g></svg><h2>Facebook Open Source</h2></div><div class="footerSection"><a class="footerLink" href="https://code.facebook.com/projects/" target="_blank">Open Source Projects</a><a class="footerLink" href="https://github.com/facebook/" target="_blank">GitHub</a><a class="footerLink" href="https://twitter.com/fbOpenSource" target="_blank">Twitter</a></div><div class="footerSection rightAlign"><a class="footerLink" href="https://github.com/facebook/jest" target="_blank">Contribute on GitHub</a></div></div></div></div></div><div id="fb-root"></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-44373548-17', 'auto');
            ga('send', 'pageview');

            !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)
            ){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";
            fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");

            docsearch({
              apiKey: '833906d7486e4059359fa58823c4ef56',
              indexName: 'jest',
              inputSelector: '#search_input_react'
            });
          </script></body></html>